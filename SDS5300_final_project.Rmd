---
title: "Winning Formula: An Analysis of F1 Race Success (2010-2024)"
author: "Andrew Fouty, Zoe Zhang"
date: "`r Sys.Date()`"
output: html_document
---


This analysis focuses on the **modern era** (2010 - 2024) of Formula 1 racing. This period represents a distinct phase in F1 history characterized by:

- **Technical Regulations**: Introduction of hybrid power units (2014), DRS (Drag Reduction System), and increased emphasis on aerodynamics
- **Dominant Teams**: The rise of Mercedes' dominance, Red Bull's continued success, and Ferrari's competitive resurgence
- **Driver Talent**: Era featuring champions like Hamilton, Vettel, Rosberg, and emerging stars
- **Competition Evolution**: More sophisticated data analytics and race strategy


We investigate factors that influence race performance (specifically, race finishing positions and fastest lap speed) in this modern competitive landscape. We are interested in whether race outcomes are driven more by the driver or the constructor. Specifically, we looked at

- whether the finishing positions differ significantly different between British and German drivers (Britain and Germany have the most F1 drivers)
- whether Fernando Alonsoâ€™s finishing positions differ between his tenures at Ferrari and Renault (Alonso has the longest career in this era and is a top performing driver)
- whether the fastest lap speed differ significantly among top constructors (i.e. Ferrari, Mercedes, McLaren, Red Bull)
- and fit a multiple linear regression model to predict the race finishing positions.



```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
# load library
library(tidyverse)
library(car)
library(boot)
library(ggplot2)
library(dplyr)
library(corrplot)
library(leaps)
library(MASS)
library(lubridate)
library(PerformanceAnalytics)
```



# Data cleaning and preparation

The data comes from [Formula 1 World Championship (1950 - 2024)] (https://www.kaggle.com/datasets/rohanrao/formula-1-world-championship-1950-2020).
The dataset consists of all information on the Formula 1 races, drivers, constructors, qualifying, circuits, lap times, pit stops, championships from 1950 till the latest 2024 season. 

The observational unit of the base dataset `result` is one result for one driver in one race, we then used left join to merge the other datasets with unique identifier such as raceId, driverId, constructorId, etc.

Overall, this dataset is fairly complete in terms of missing data. The Kaggle/Ergast dataset uses the string ("\N") for missing data, so we treated the string \N in the input data as a missing value (NA), making sure numeric columns are numeric as they're supposed to. 

We filtered out pit stop records exceeding 60 seconds, as these extreme values are most likely outliers caused by race stoppages (e.g. red flags) rather than active competitive pit stops. We also excluded race finishing position larger than 20 since there are only 20 cars on the track each race.

We created a few new continuous and categorical/binary variables, including pit stop duration, driver's age at the year of race, finish on podium (Y/N), finish with points (Y/N). Not all variables were included in the final analysis and output.



```{r echo=FALSE}
# Load datasets
base_url <- "https://raw.githubusercontent.com/zoe-zg/SDS5300-final-project/main/data/"

f1_results <- read.csv(paste0(base_url, "results.csv"), na.strings = "\\N")
f1_constructor_results <- read.csv(paste0(base_url, "constructor_results.csv"), na.strings = "\\N")
f1_races <- read.csv(paste0(base_url, "races.csv"), na.strings = "\\N")
f1_drivers <- read.csv(paste0(base_url, "drivers.csv"), na.strings = "\\N")
f1_constructors <- read.csv(paste0(base_url, "constructors.csv"), na.strings = "\\N")
f1_driver_standings <- read.csv(paste0(base_url, "driver_standings.csv"), na.strings = "\\N")
f1_constructor_standings <- read.csv(paste0(base_url, "constructor_standings.csv"), na.strings = "\\N")
f1_quali <- read.csv(paste0(base_url, "qualifying.csv"), na.strings = "\\N")
f1_lap_times <- read.csv(paste0(base_url, "lap_times.csv"), na.strings = "\\N")
f1_pit_stops <- read.csv(paste0(base_url, "pit_stops.csv"), na.strings = "\\N")
# f1_status <- read.csv(paste0(base_url, "status.csv"), na.strings = "\\N")
# f1_seasons <- read.csv(paste0(base_url, "seasons.csv"), na.strings = "\\N")

f1_pit_summary <- f1_pit_stops %>% 
  group_by(raceId, driverId) %>% 
  summarize(duration = mean(milliseconds)/1000)

# Merge datasets
f1_data <- f1_results %>%  
  left_join(f1_races, by = "raceId") %>%
  left_join(f1_drivers, by = "driverId") %>%
  left_join(f1_constructors, by = "constructorId") %>% 
  left_join(f1_pit_summary, by = c("raceId", "driverId")) %>% 
  rename(driver_nationality = nationality.x, constructor_nationality = nationality.y,
         race_name = name.x, constructor_name = name.y) %>% 
  dplyr::select(raceId, year, round, driverId, circuitId, race_name, grid, positionOrder, points, positionText,
         driverRef, constructorRef, driver_nationality, constructor_nationality,
         statusId, laps, fastestLapSpeed, fastestLapTime, fastestLap, dob, milliseconds, round, duration) 

# f1_driver_standings <- f1_driver_standings %>% 
#   left_join(f1_drivers, by = "driverId")

```

Below are the dimensions of the cleaned dataframe.

```{r echo=FALSE}

# Text Character Replacement / Cleaning
f1_data <- f1_data %>% mutate(fastestLapSeconds = as.numeric(ms(fastestLapTime)))

f1_clean <- f1_data %>% 
  filter(year >= 2010) %>%
  mutate(driverRef = as.factor(driverRef),
         constructorRef = as.factor(constructorRef),
         # is_points = ifelse(positionOrder <= 10, 1, 0),
         # is_points = as.factor(is_points), 
         # did the driver finish on the podium (top 3 finish)
         # is_podium = ifelse(positionOrder <=3, 1, 0),
         # is_podium = as.factor(is_podium),
         fastestLapSpeed = as.numeric(as.character(fastestLapSpeed)),
         age = year - as.numeric(substr(dob, 1, 4)),
         # race_completion = positionText
         ) %>% 
  # missing values
  drop_na(grid, positionOrder)


n_rows <- nrow(f1_clean)    # Number of rows
n_cols <- ncol(f1_clean)    # Number of columns

# Create a new data frame to act as a summary table
dimension_summary <- data.frame(
  Dimension = c("Rows (Observations)", "Columns (Variables)"),
  Count = c(n_rows, n_cols)
)

# Print the summary table
print(dimension_summary)

```

Below are the first 6 rows of the dataframe.

```{r echo=FALSE}
head(f1_clean)
```



# A sneak peek into the rivals

## British vs German drivers
Here we compare the race finishing positions between British and German drivers from the two most dominant countries in F1 racing and in automobile.
By visual inspection, we can see clear mean race finishing positions between these two countries, with British drivers having a better race finishing results (finishing position lower is better).

```{r echo=FALSE}
# driver counts by country

# f1_clean %>% group_by(driver_nationality) %>% 
#   summarize(unique_drivers = n_distinct(driverRef)) %>% 
#   arrange(desc(unique_drivers))

f1_brit_german <- f1_clean %>% filter(driver_nationality %in% c("British", "German"))

boxplot(positionOrder ~ driver_nationality,
        data = f1_brit_german,
        main = "Race Finishing Position: British vs German Drivers",
        ylab = "Finishing Position",
        xlab = ""
          )
```

We then performed a two-sample t-test to examine if the difference is significant. Using an alpha level of 0.05, the result shows that there is a statistically significant difference in the finishing position between the two groups. 

```{r echo=FALSE}
ttest_brit_german <- t.test(positionOrder ~ driver_nationality, data = f1_brit_german, conf.level = 0.95)
ttest_brit_german
```

We also performed a bootstrap test to confirm our results from the t-test. The bootstrapped CI and theoretical CI are very close and symmetrical; neither include 0. Also shown below is the Normal Q-Q plot of bootstrapped differences, normally distributed as we would anticipate.

```{r echo=FALSE}

set.seed(230) 

# FILL IN REMAINING CODE
n_samp <- 10000

diff_brit_german <- rep(NA, n_samp)

for (i in 1:n_samp) {
  brit <- sample(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "British"], 
                 sum(f1_brit_german$driver_nationality == "British"), replace = TRUE)
  german <- sample(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"],
                 sum(f1_brit_german$driver_nationality == "German"), replace = TRUE)
  diff_brit_german[i] <- mean(brit) - mean(german)
}

# Calculate a 95% Bootstrap confidence interval. Show your results rounded to two decimal places
ci <- quantile(diff_brit_german, c(0.025, 0.975))
# round(ci, 2)

# Histogram of bootstrap difference in means and add CI lines
hist(diff_brit_german, col = "grey", main = "Bootstrapped Sample Means Diff in Race Finishing Position", xlab = "Race Finishing Position", breaks = 50)

abline(v = ci, lwd = 3, col = "orange")
abline(v = ttest_brit_german$conf.int, lwd = 3, col = "black", lty = 2)
legend("topright", c("Theoretical CI","Bootstrap CI"), lwd = 3, col = c("black","orange"), lty = c(2,1))


# Normal Q-Q plot of bootstrapped differences
qqPlot(diff_brit_german, main = "Normal Q-Q Plot of Bootstrap Differences")


```
We also performed a permutation test to show that our results from all three tests are consistent.
This suggests that none of our 10000 simulations produced a difference that was more extreme than the actual difference in means. We see a permuted p-value of 0, suggesting that the probability of seeing this difference between groups under null hypothesis is extremely unlikely.


```{r echo=FALSE}

set.seed(230)

N <- 100000
diffvals <- rep(NA, N)

# assign countries at random to each group, compute statistic and store
for (i in 1:N) {
  shuffled_country <- sample(f1_brit_german$driver_nationality)  # default is replace = FALSE
  diffvals[i] <- as.numeric(mean(f1_brit_german$positionOrder[shuffled_country == "British"], na.rm = T) -  mean(f1_brit_german$positionOrder[shuffled_country == "German"], na.rm = T))
}

# observed difference in medians 
diff_obs <- mean(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "British"], na.rm = T) -
  mean(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"], na.rm = T)

# make histogram of permuted median differences
hist(diffvals, 
     main = "Permuted sample mean difference in finishing position", 
     xlab = "Finishing position",
     xlim = c(-2, 2),
     col = "lightgrey",
     breaks = 50)
abline(v = diff_obs, col = "blue", lwd = 3, lty = "dotted")
text(diff_obs - 0.2, 1500 , paste("Actual Diff in Means =", round(diffrate_obs,2)), srt = 90)

paste0("The permuted p-value is ",  mean(abs(diffvals) >= abs(diff_obs)), ".")

```






## Alonso finishing positions different at Ferrari vs Renault


add boxplot


```{r echo=FALSE}
f1_alonso_test <- f1_alonso[f1_alonso$constructorRef %in% c("mclaren", "ferrari"), ]


ttest_alonso <- t.test(positionOrder ~ constructorRef, data = f1_alonso_test, conf.level = 0.95)
ttest_alonso

# p value lower than 0.01, CI doesn't include 0, reject null hypothesis, there is evidence of a difference between British and German drivers
```


```{r}
# To make grading easier, please leave the following line of code in your assignment
set.seed(230) 

# FILL IN REMAINING CODE
n_samp <- 10000

diff_alonso <- rep(NA, n_samp)

for (i in 1:n_samp) {
  mclaren <- sample(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "mclaren"], 
                 sum(f1_alonso_test$constructorRef == "mclaren"), replace = TRUE)
  ferrari <- sample(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "ferrari"],
                 sum(f1_alonso_test$constructorRef == "ferrari"), replace = TRUE)
  diff_alonso[i] <- mean(ferrari) - mean(mclaren)
}

# Calculate a 99% Bootstrap confidence interval. Show your results rounded to two decimal places
ci <- quantile(diff_alonso, c(0.005, 0.995))
round(ci, 2)

# Histogram of bootstrap difference in means and add CI lines
hist(diff_alonso, col = "grey", main = "Bootstrapped Sample Means Diff in Race Finishing Position", xlab = "Race Finishing Position", breaks = 50)

abline(v = ci, lwd = 3, col = "orange")
abline(v = ttest_alonso$conf.int, lwd = 3, col = "pink", lty = 2)
legend("topright", c("Theoretical CI","Bootstrap CI"), lwd = 3, col = c("pink","orange"), lty = c(2,1))


# Normal Q-Q plot of bootstrapped differences
qqPlot(diff_alonso, main = "Normal Q-Q Plot of Bootstrap Differences")
```


```{r echo=FALSE}

set.seed(230)

N <- 10000
diffvals <- rep(NA, N)

# assign countries at random to each group, compute statistic and store
for (i in 1:N) {
  shuffled_team <- sample(f1_alonso_test$constructorRef)  # default is replace = FALSE
  diffvals[i] <- as.numeric(mean(f1_alonso_test$positionOrder[shuffled_team == "mclaren"], na.rm = T) -  mean(f1_alonso_test$positionOrder[shuffled_team == "ferrari"], na.rm = T))
}

# observed difference in medians 
diff_obs <- mean(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "mclaren"], na.rm = T) -
  mean(f1_alonso_test$positionOrder[f1_alonso_test$constructorRef == "ferrari"], na.rm = T)

# make histogram of permuted median differences
hist(diffvals, 
     main = "Permuted sample median difference in finishing position", 
     xlab = "Finishing position",
     xlim = c(-6,6),
     col = "lightgrey",
     breaks = 50)
abline(v = diff_obs, col = "blue", lwd = 3, lty = "dotted")
text(diff_obs - 0.2, 1500 , paste("Actual Diff in Medians =", round(diffrate_obs,2)), srt = 90)

```


###### 1) Alonso: quali vs. race result
```{r echo=FALSE}
f1_alonso <- f1_data[f1_data$driverRef == "alonso", ]

ggplot(f1_alonso, aes( x = grid, y = positionOrder)) +
  geom_jitter(color = "lightblue", alpha = 0.6, size = 4) + 
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50") +
  geom_smooth(method = "lm", color = "black", se = FALSE, size = 0.5) +
  scale_x_continuous(breaks = seq(0, 20, 5)) +
  scale_y_continuous(breaks = seq(0, 20, 5)) +
  labs(title = "Qualifying vs. Race Results: Fernando Alonso",
       subtitle = "Points below the dashed line indicate positions gained during the race",
       x = "Starting Grid Position",
       y = "Finishing Position") +
    theme_linedraw()

```





###### 2) Correlation
```{r}

# cor_est <- cor(f1_clean$grid, f1_clean$positionOrder)
# print(paste("Pearson Correlation:", round(cor_est, 3)))

# f1_clean_sub %>%
#   filter(driverRef %in% top_teams)

plot(jitter(grid, factor = 2) ~ jitter(positionOrder, factor = 2), data = f1_clean_alonso, main = "", 
     xlab = "", ylab = "", pch = 19, col = "blue")
abline(lm(grid ~ positionOrder, data = f1_clean_alonso), col = "red")


lm_alonso <- lm(grid ~ positionOrder, data = f1_clean_alonso)
summary(lm_alonso)

r <- rstudent(lm_alonso)
f <- fitted(lm_alonso)

plot(r ~ f)

source("https://raw.githubusercontent.com/jreuning/sds230_files/refs/heads/main/regJDRS.txt")
myResPlots(lm_alonso, label = "")


# 
# plot(jitter(fastestLapSpeed) ~ jitter(age), data = f1_clean_hamiltom, main = "", 
#      xlab = "", ylab = "", pch = 19, col = "blue")
# abline(lm(fastestLapSpeed ~ age, data = f1_clean_hamiltom), col = "red")
# 
# 
# plot(jitter(grid) ~ jitter(age), data = f1_clean_hamiltom, main = "", 
#      xlab = "", ylab = "", pch = 19, col = "blue")
# abline(lm(grid ~ age, data = f1_clean_hamiltom), col = "red")

```


## More plots

The figure below includes the histgram plots of 
- fastest lap speed
- driver's age
- fastest lap time
- mean pit stop time

```{r echo=FALSE}
par(mfrow = c(2, 2))
f1_clean_pit <- f1_clean %>% filter(duration <= 60)

hist(f1_clean$fastestLapSpeed,
     breaks = 20,
     col = "grey40", 
     border = "white",
     main = "Fastest Lap Speeds",
     xlab = "Speed (km/h)",
     las = 1) 

hist(f1_clean$age,
     breaks = 15,
     col = "grey40",
     border = "white",
     main = "Driver's Age",
     xlab = "Age (Years)",
     las = 1)

hist(f1_clean$fastestLapSeconds,
     breaks = 20,
     col = "grey40",
     border = "white",
     main = "Fastest Lap Times",
     xlab = "Time (seconds)",
     las = 1)

hist(f1_clean_pit$duration,
     breaks = 40, # More breaks to see the "two peaks" detail
     col = "grey40",
     border = "white",
     main = "Pit Stop Duration (<60s)",
     xlab = "Duration (seconds)",
     las = 1)

# hist(f1_brit_german$positionOrder[f1_brit_german$driver_nationality == "German"])

```

##### Q-Q normal quantile plot

```{r echo=FALSE}

par(mfrow = c(2, 2))
qqPlot(f1_clean$fastestLapSpeed, 
       main = "QQ Plot: Fastest Lap Speed",
       ylab = "Speed (km/h)",
       col = "red", pch = 19, cex = 0.5)

qqPlot(f1_clean$age, 
       main = "QQ Plot: Driver's Age",
       ylab = "Age (Years",
       col = "red", pch = 19, cex = 0.5)

qqPlot(f1_clean$fastestLapSeconds, 
       main = "QQ Plot: Fastest Lap Time",
       ylab = "Time (Seconds)",
       col = "red", pch = 19, cex = 0.5)

qqPlot(log10(f1_clean_pit$duration), 
       main = "QQ Plot: QQ Plot: Pit Stop Duration (<60s)",
       ylab = "Duration (Seconds)",
       col = "red", pch = 19, cex = 0.5)

```






# A closer look
## [ANOVA] Ferrari vs Red Bull vs McLaren vs Mercedes






## [Multiple Linear Regression] positionOrder ~ a+b+c+d



# TBD

```{r echo=FALSE}

f1_country_most_driver <- f1_clean %>% filter(driver_nationality %in% c("British", "German", "Brazilian", "French", "Spanish"))

boxplot(positionOrder ~ driver_nationality, 
        data = f1_country_most_driver,
        main = "Finishing Positions by Country",
        xlab = "",
        ylab = "Finishing Position",
        las = 1)


boxplot(fastestLapSpeed ~ constructorRef, 
        data = f1_country_most_driver,
        main = "Fastest Lap Speed by Team",
        xlab = "",
        ylab = "Fastest Lap Speed (km/h)",
        las = 2)

```




###### 2) top drivers' quali vs race result
```{r echo=FALSE}

# --- Comparison of Top Drivers ---
top_drivers <- c("hamilton", "vettel", "alonso", "max_verstappen", "norris", "piastri", "leclerc", "russell", "sainz", "michael_schumacher")

f1_clean %>%
  filter(driverRef %in% top_drivers) %>%
  ggplot(aes(x = grid, y = positionOrder, color = driverRef)) +
  geom_point(alpha = 0.4) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "grey50") +
  # geom_smooth(method = "lm", color = "grey", se = FALSE, size = 0.5) +
  labs(title = "Qualifying vs. Race Result: Top Drivers Comparison",
       x = "Starting Grid Position",
       y = "Finishing Position") +
  theme_linedraw()  +
  facet_wrap(~driverRef) +
  theme(legend.position = "none", 
        strip.text = element_text(size = 12, face = "bold", color = "Black"),
        strip.background = element_rect(fill = "grey90"))

# cor_data <- f1_clean %>%
#   select(grid, positionOrder, fastestLapSpeed, points) %>%
#   drop_na()
# 
#   
# corrplot(cor(cor_data), method = "circle", type = "upper", 
#          title = "Correlation Matrix: Top Drivers (2010-2020)", 
#          mar = c(0,0,2,0), 
#          addCoef.col = "black") # Add numbers
```

###### 3) drivers' fastest lap time at Silverstone by year (2004-2024)

```{r echo=FALSE}

f1_britGP <- f1_data %>% filter(race_name == "British Grand Prix", year >= 2004) %>% 
  mutate(decade = floor(year / 10) * 10, decade_label = as.factor(paste0(decade, "s")))

scatterplot(fastestLapSeconds ~ year, 
        data = f1_britGP,
        main = "Fastest Lap Time by Country",
        xlab = "",
        ylab = "Fastest Lap Time (seconds)",
        ylim = c(60, 120),
        las = 1)
```




Top 15 fastest circuits
```{r}
top_15_names <- f1_clean %>%
  group_by(name) %>%
  summarise(mean_speed = mean(fastestLapSpeed)) %>%
  slice_max(mean_speed, n = 15) %>%
  pull(name)

top_15_data <- circuit_speeds %>% filter(name %in% top_15_names)

ggplot(top_15_data, aes(x = reorder(name, fastestLapSpeed), y = fastestLapSpeed, fill = name)) +
  # The Violin shows the distribution shape (density)
  geom_violin(trim = FALSE, alpha = 0.6) +

  # Adding a narrow boxplot inside gives you the median/quartiles (Best of both worlds)
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  
  coord_flip() + # Horizontal is easier to read
  
  labs(title = "Top 15 Fastest F1 Circuits (Violin Plot)",
       subtitle = "Shape represents distribution of lap speeds. White bar is the interquartile range.",
       x = NULL,
       y = "Fastest Lap Speed (km/h)") +
  theme_bw() +
  theme(legend.position = "none")
  
# distribution of speeds of all races
ggplot(circuit_speeds, aes(x = fastestLapSpeed)) +
  geom_histogram(binwidth = 5, fill = "steelblue", color = "white", alpha = 0.7) +
  labs(title = "Distribution of Fastest Lap Speeds Across All Races",
       x = "Speed (km/h)",
       y = "Count") +
  theme_bw()
```



```{r}
# Top 5 Teams only (to keep categorical variables manageable)

f1_final <- f1_clean %>%
  filter(constructorRef %in% top_teams) %>%
  droplevels()

# --- 2. Graphics ---
par(mfrow=c(2,2)) # Set up 2x2 plotting grid

# 1. Scatterplot: Grid vs Finish
plot(positionOrder ~ grid, data = f1_final, main = "Grid vs. Finish Position", 
     xlab = "Grid Position", ylab = "Finish Position", pch = 19, col = "blue")
abline(lm(positionOrder ~ grid, data = f1_final), col = "red")

# 2. Boxplot: Finish by Team
boxplot(positionOrder ~ constructorRef, data = f1_final, main = "Finish by Team", 
        las = 2, col = "lightblue")

# 3. Histogram: Distribution of Grid Positions
hist(f1_final$grid, main = "Distribution of Grid Positions", 
     xlab = "Grid Position", col = "lightgreen", border = "white")

# 4. Normal Quantile Plot (on residuals of a simple model)
simple_model <- lm(positionOrder ~ grid, data = f1_final)
qqnorm(residuals(simple_model), main = "Normal Q-Q Plot of Residuals")
qqline(residuals(simple_model), col = "red")

par(mfrow=c(1,1)) # Reset plotting grid

# --- 3. Basic Tests ---
# 1. T-test: Compare average finish position of Mercedes vs. Ferrari
mercedes_pos <- f1_final$positionOrder[f1_final$constructorRef == "mercedes"]
ferrari_pos <- f1_final$positionOrder[f1_final$constructorRef == "ferrari"]

t_test_result <- t.test(mercedes_pos, ferrari_pos)
print(t_test_result)
# Interpretation: If p-value < 0.05, there is a significant difference in mean finish position.

# 2. Correlation
cor_val <- cor(f1_final$grid, f1_final$positionOrder)
cat("Correlation between Grid and Finish:", cor_val, "\n")

# 3. Bootstrap CI for Correlation
corr_fun <- function(data, indices) {
  d <- data[indices, ]
  return(cor(d$grid, d$positionOrder))
}
set.seed(123)
boot_results <- boot(data = f1_final, statistic = corr_fun, R = 1000)
print(boot.ci(boot_results, type = "perc"))

# --- 4. Permutation Test ---
# Hypothesis: Does Lewis Hamilton finish significantly better (lower position) than the average of all other drivers?
# Test Statistic: Difference in means (Others - Hamilton). Positive value means Hamilton is better (lower score).

obs_diff <- mean(f1_final$positionOrder[f1_final$driverRef != "hamilton"]) - 
            mean(f1_final$positionOrder[f1_final$driverRef == "hamilton"])

cat("Observed Difference (Others - Hamilton):", obs_diff, "\n")

```


 Permutation test
```{r}
# Permutation Loop
set.seed(123)
n_perms <- 1000
perm_diffs <- numeric(n_perms)
all_positions <- f1_final$positionOrder

for (i in 1:n_perms) {
  # Shuffle the positions
  shuffled_pos <- sample(all_positions)
  
  # Assign shuffled positions to groups based on original indices
  # (We keep the group sizes fixed: Hamilton vs Others)
  hamilton_indices <- which(f1_final$driverRef == "hamilton")
  
  mean_hamilton_perm <- mean(shuffled_pos[hamilton_indices])
  mean_others_perm <- mean(shuffled_pos[-hamilton_indices])
  
  perm_diffs[i] <- mean_others_perm - mean_hamilton_perm
}

# P-value: Proportion of permutations where the difference is as extreme or more extreme than observed
p_value <- mean(perm_diffs >= obs_diff)
cat("Permutation Test P-value:", p_value, "\n")
hist(perm_diffs, main = "Permutation Distribution", xlab = "Difference in Means", col = "gray")
abline(v = obs_diff, col = "red", lwd = 2)

```


Multiple Regression 
```{r}
# --- 5. Multiple Regression ---
# Using Stepwise Regression (Backward)
# Model: Predict Finish Position based on Grid, Team, and Year
full_model <- lm(positionOrder ~ grid + constructorRef + year, data = f1_final)
step_model <- step(full_model, direction = "backward", trace = 0) # trace=0 suppresses output

summary(step_model)

# Residual Plots for the final model
par(mfrow=c(2,2))
plot(step_model)
par(mfrow=c(1,1))

# Interpretation:
# - Intercept: Baseline finish position.
# - Grid: For every 1 spot further back on the grid, finish position increases by approx [coefficient].
# - Constructor: Coefficients show difference relative to the reference team.
# - Year: Effect of time on finish position (if significant).

# --- 6. Advanced Technique: Binary Logistic Regression ---
# Predict probability of finishing in the points (Top 10)
log_model <- glm(in_points ~ grid + constructorRef, data = f1_final, family = "binomial")
summary(log_model)

# Interpretation of Odds Ratios
odds_ratios <- exp(coef(log_model))
cat("Odds Ratios:\n")
print(odds_ratios)
# Example: If Grid OR < 1, starting further back decreases odds of points.
# Example: If Mercedes OR > 1, being in Mercedes increases odds of points vs baseline team.
```

